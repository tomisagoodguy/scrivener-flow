---
description: 創建任務文件工作流
---

# 創建任務文件工作流

當用戶需要創建一個可在新對話中執行的任務時，使用此工作流。

---

## 核心原則

你擁有充足的時間，要有耐心地進行深度分析和思考。

### 任務文件的本質

任務文件是**執行邏輯的文字描述**：
- 包含「做什麼」和「為什麼」
- 執行者根據描述自己編寫代碼

### 核心行為準則

1. **深度研究** — 完整收集上下文後再開始撰寫，從本地代碼和網路資源中理解問題的 root cause
2. **文字描述** — 用自然語言描述執行邏輯，讓人類閱讀比代碼更快
3. **決策透明** — 記錄所有技術決策，無論是用戶確認還是代理選擇
4. **可驗證產出** — 每個驗收標準都必須是可測試或可觀察的

---

## 第一階段：需求理解和技術決策收集

### 1.1 理解任務需求

仔細閱讀用戶的任務描述，確認：
- 任務的核心目標
- 涉及的模組/文件
- 預期的產出

### 1.2 深度收集上下文（必須完成）

**這個步驟不能跳過，不計開銷**。根據任務性質執行對應的研究方法：

| 任務性質 | 執行的研究方法 |
|----------|----------------|
| 修改現有代碼 | → 執行 [附錄 A：本地代碼研究](#附錄-a本地代碼研究) |
| 使用外部庫或 API | → 執行 [附錄 B：網路資源研究](#附錄-b網路資源研究) |
| 兩者都涉及 | → 兩個附錄都執行 |

完成研究後，你應該掌握：
- 現有實現的結構體/類/介面定義和函數簽名
- 相關模組的調用關係
- 現有代碼的設計模式和約定
- 外部庫的正確使用方式和限制
- 可能的技術限制或依賴

### 1.3 技術決策處理

在研究過程中，列出所有需要決定的技術選項：

**如果用戶沒有提供完整決策**：
1. 優先詢問用戶
2. 如果自行決定，必須在任務文件中明確記錄決策及理由

```markdown
## 技術決策記錄

### 已確認（用戶決定）
- **UI 框架**: 使用 Tailwind CSS — 用戶指定

### 待確認（需詢問用戶）
- **錯誤重試策略**: 指數退避 vs 固定間隔？

### 已決定（代理選擇）
- **Log 格式**: JSON — 與現有後端一致
```

---

## 第二階段：創建任務文件

### 2.0 準備工作

確保目錄存在：
```bash
if (!(Test-Path ".agent/tasks")) { mkdir ".agent/tasks" }
```

### 2.1 文件命名

文件名規則：`snake_case.md`，放在 `.agent/tasks/` 目錄。
例如：`implement_login_flow.md`, `fix_memory_leak.md`

### 2.2 任務文件結構範本

```markdown
# {任務標題}

## 背景與目的

### 目的
{一兩句話說明這個任務要達成什麼}

### 項目上下文
{與這個修改相關的項目背景，讓執行者快速理解}

### 相關文件
- `src/components/Button.tsx` — 現有的 UI 組件
- `src/utils/api.ts` — 要修改的 API 模組

---

## 技術決策記錄

### 已確認
- **決策 1**: 選項 A — 理由

### 已決定（代理選擇）
- **決策 2**: 選項 B — 與現有專案規範一致

---

## 實現計劃

### 項目 1: `ModuleName / ComponentName`

**目的**: 這個模組/組件的主要職責

**簽名/介面**:
```typescript
// 或 Python/Rust 等其他語言
interface Props {
  user: User;
  onLogin: () => void;
}
```

**執行過程**:

首先驗證輸入參數...

接著調用後端 API `POST /api/login`...

最後根據回傳值更新 Context 狀態...

---

### 項目 2: `AnotherFunction`

**目的**: ...

**執行過程**:
{按順序描述執行邏輯}

---

## 驗收標準

**自動化測試**:
- [ ] **AC-1** [test] `test_login_success` — 測試登入成功流程
- [ ] **AC-2** [test] `test_invalid_password` — 測試密碼錯誤處理

**人工驗證**:
- [ ] **AC-3** [manual] 登入頁面在 Mobile 版顯示正常

**構建檢查**:
- [ ] **AC-4** [build] `npm run lint` 無錯誤 (或 `cargo check`, `ruff check`)
- [ ] **AC-5** [build] `npm run build` 成功

---

## 注意事項

1. {重要提醒}
2. {潛在陷阱}
```

---

## 描述風格指引

### 判斷標準：靠近業務邏輯的程度

| 類型 | 判斷標準 | 描述方式 |
|------|----------|----------|
| 核心 | 直接表達業務意圖的實體、API | 代碼簽名 + 詳細執行過程 |
| 高級 | 實現業務邏輯的主要函數 | 目的 + 簽名 + 執行過程 |
| 低級 | 輔助性函數、實現細節 | 簽名 + 一句話，或省略 |

### 允許寫代碼的情況

僅限於**預先定義的接口契約**：
- 核心型別定義（Interface, Type, Struct, Model）
- 對外 API 函數簽名
- 配置檔結構

這些是設計決策的核心，不容易過時。

---

## 驗收標準指引

**每個驗收標準必須是可驗證的。**

### 格式要求
1. **勾選框** `- [ ]`
2. **全局序號** `AC-N`
3. **類型標記** `[test]`/`[manual]`/`[build]`
4. **描述**

### 類型標記說明

| 標記 | 含義 | 範例 |
|------|------|------|
| `[test]` | 自動化測試 (Unit/Integration) | `[test] 用戶輸入非法 email 時顯示錯誤` |
| `[manual]` | 人工驗證 (UI/UX) | `[manual] 按鈕 Hover 狀態顏色正確` |
| `[build]` | 靜態檢查/編譯 | `[build] TypeScript 編譯無錯誤` |

---

## 第三階段：品質自檢

創建完成後，檢查以下項目：

| 檢查項 | 要求 |
|--------|------|
| 背景充足 | 執行者不需要額外查資料就能理解項目 |
| 邏輯清晰 | 用文字描述做什麼，不是寫大段實作代碼 |
| 決策記錄 | 所有技術決策都有記錄 |
| 驗收可測 | 每個 `[test]` 都能對應到具體的測試腳本 |

---

## 交付

創建文件後，告知用戶：

> 任務文件已創建：`.agent/tasks/{name}.md`
>
> 在新對話中使用 `@[.agent/tasks/{name}.md]` (或直接引用路徑) 開始執行任務。

---
---

# 附錄

以下附錄包含深度研究的完整方法論，在 1.2 節中根據條件執行。

---

## 附錄 A：本地代碼研究

// turbo-all

當任務涉及修改現有代碼時，必須完整執行以下步驟。

### A.1 核心原則

1. **完整性優先** — 必須完整理解目標代碼的結構和邏輯
2. **代碼優先** — 以實際代碼為準
3. **引用來源** — 標註原始文件路徑和行號

### A.1.5 項目文檔掃描（強制優先）

**在分析代碼結構前，必須先閱讀項目內部的所有文檔。**

使用 `find_by_name` 搜索項目及目標目錄中的所有 md 文件。

閱讀相關文檔：
- 根目錄 `README.md`
- 目標模組的 `README.md`
- 其他相關文檔

### A.2 結構探索

使用 `list_dir` 獲取完整目錄結構，關注：
- **入口文件** (index.ts, main.py, mod.rs 等)
- **核心模組** (components, models, services)
- **測試文件** (tests, __tests__, spec.ts)

使用 `view_file_outline` 或 `read_text_file` (head) 獲取文件概覽。

### A.3 深度閱讀

使用 `view_file` 按順序閱讀：
1. **入口文件**
2. **核心資料結構** (Interfaces, Models, Types)
3. **公開 API** (Public functions, API endpoints)
4. **關鍵實現** (複雜的業務邏輯)

在閱讀過程中識別並記錄：
- **設計模式** (MVC, MVVM, Builder, etc.)
- **錯誤處理** (Try-catch, Result result, Error boundaries)
- **異步模式** (Promise, Async/Await, Reactive)
- **命名慣例**

### A.4 依賴追蹤

使用 `grep_search` 追蹤：
- 模組導入 (`import`, `require`, `use`)
- 類型定義 (`interface`, `type`, `class`)
- 函數調用

檢查依賴管理文件：
- `package.json` (JS/TS)
- `pyproject.toml` / `requirements.txt` (Python)
- `Cargo.toml` (Rust)

---

## 附錄 B：網路資源研究

// turbo-all

當任務涉及使用外部庫或 API 時，必須完整執行以下步驟。

### B.1 核心原則

1. **完整性優先**
2. **事實優先** (官方文檔 > 博客文章)
3. **引用來源**

### B.2 多維度搜索

使用 `search_web` 進行系統性搜索。

**搜索策略**：
- **官方文檔**: `"[LibName] documentation"`
- **API 參考**: `"[LibName] API reference"`
- **最新版本**: `"[LibName] latest version"`
- **常見問題**: `"[LibName] common pitfalls"`
- **最佳實踐**: `"[LibName] best practices"`

### B.3 深度閱讀

對每個重要來源使用 `read_url_content` 提取完整內容：

**必讀來源**：
1. **官方文檔首頁**
2. **Getting Started**
3. **API Reference** (針對特定功能)

**GitHub 倉庫文檔**：
- `README.md`
- `docs/` 目錄

### B.4 交叉驗證

- 確認文檔版本與專案使用版本一致
- 檢查 GitHub Issues 排除已知 Bug

### B.5 引用格式

```
// 根據 React 18 文檔 (https://react.dev/...)
// useEffect 在 StrictMode 下會執行兩次
```
