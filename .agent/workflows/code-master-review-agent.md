---
description: 完整代碼審查 Master Workflow（協調多個專業 agents）
---

你是專案品質總監與技術審查協調者。請執行完整的程式碼品質檢查流程，依序呼叫專業 agents 並整合結果，最終產出優先級排序的改善建議。

## 執行流程

### 1. 代碼品質審查
```
呼叫 /code-review-agent
```

**等待完成後記錄：**
- High 風險問題數量
- Medium 風險問題數量
- Low 風險問題數量
- 主要問題類別（效能、錯誤處理、模組邊界、命名）

---

### 2. 安全審查
```
呼叫 /security-review-agent
```

**等待完成後記錄：**
- High 安全風險數量（機密外洩、注入漏洞）
- Medium 安全風險數量（權限問題、日誌洩漏）
- Low 安全風險數量（依賴過舊）
- 是否有緊急修正項目

---

### 3. 效能分析
```
呼叫 /performance-agent
```

**等待完成後記錄：**
- CPU/演算法複雜度問題
- 記憶體使用問題
- I/O 瓶頸
- 效能改善預估效益

---

### 4. 測試覆蓋率檢查
```
呼叫 /testing-agent
```

**等待完成後記錄：**
- 整體測試覆蓋率
- 失敗測試數量
- 低覆蓋率模組（< 80%）
- 建議新增的測試數量

---

### 5. 資料庫設計審查（若專案涉及資料庫）
```
呼叫 /db-schema-agent
```

**等待完成後記錄：**
- Schema 設計問題
- 索引策略問題
- 查詢效能問題
- 資料一致性風險

---

## 綜合報告生成

整合上述所有 agents 的結果，產出以下報告：

### 📊 總體品質評分

根據以下標準計算：
- **安全性分數**: 100 - (High風險 × 20 + Medium × 10 + Low × 5)
- **品質分數**: 100 - (High問題 × 15 + Medium × 8 + Low × 3)
- **效能分數**: 根據瓶頸嚴重程度評估
- **測試分數**: 測試覆蓋率百分比

```
總體評分: X / 100

安全性: ██████████ 85/100
程式品質: ████████░░ 78/100
效能: ███████░░░ 72/100
測試覆蓋: ████████░░ 80/100
```

---

### 🚨 高優先級問題（需立即處理）

整合所有 agents 的 High 風險項目，依照影響程度排序：

#### P0 - 緊急（安全風險或嚴重 bug）
1. **[安全] API Key 硬編碼在 src/config.py:12**
   - 來源：security-review-agent
   - 風險：機密外洩，可能導致未授權存取
   - 建議：立即移至環境變數，revoke 現有 key

2. **[品質] 無錯誤處理的資料庫連線 src/db.py:45**
   - 來源：code-review-agent
   - 風險：連線失敗導致程式崩潰
   - 建議：新增 try-except 與重試機制

#### P1 - 高優先（效能瓶頸或設計缺陷）
3. **[效能] N+1 查詢問題 src/api/users.py:78**
   - 來源：performance-agent
   - 影響：每次請求執行 1000+ 次資料庫查詢
   - 建議：使用 join 或 prefetch 減少查詢次數

4. **[測試] 核心業務邏輯無測試覆蓋 src/business/payment.py**
   - 來源：testing-agent
   - 風險：支付邏輯錯誤可能導致金額錯誤
   - 建議：立即新增 5 個關鍵測試用例

---

### ⚠️ 中優先級問題

整合所有 Medium 風險項目：

5. **[品質] 函式過長 src/api/reports.py::generate_report (200 行)**
   - 建議：拆分為 4 個子函式

6. **[安全] Log 可能包含使用者個資 src/logger.py:34**
   - 建議：過濾敏感欄位後再記錄

7. **[效能] 未使用快取的重複計算 src/analytics/metrics.py:56**
   - 建議：使用 functools.lru_cache

8. **[資料庫] 缺少索引導致慢查詢 users.email**
   - 建議：新增 CREATE INDEX idx_users_email

---

### 📋 低優先級改善建議

整合所有 Low 風險項目：

- 命名一致性改善（15 處）
- 程式碼格式調整（8 處）
- 註解完整性（12 處需補充）
- 依賴套件更新（3 個非關鍵套件）

---

### 🎯 修復建議順序

根據影響範圍與修復難度，建議以下處理順序：

#### 階段 1：緊急修復（1-2 天）
1. 移除硬編碼 API Key → 呼叫 `/security-review-agent` 確認
2. 新增資料庫錯誤處理 → 呼叫 `/testing-agent` 驗證

#### 階段 2：效能優化（3-5 天）
3. 修復 N+1 查詢問題 → 呼叫 `/performance-agent` 驗證改善
4. 新增支付邏輯測試 → 呼叫 `/testing-agent` 確認覆蓋率

#### 階段 3：程式碼品質（1 週）
5. 重構過長函式
6. 新增缺少的索引
7. 改善日誌機制

#### 階段 4：持續改善（ongoing）
8. 提升測試覆蓋率至 90%
9. 處理低優先級命名與格式問題

---

### 📈 改善追蹤指標

建議在修復後重新執行此 workflow，追蹤以下指標：

| 指標 | 當前值 | 目標值 |
|------|--------|--------|
| 總體評分 | 78/100 | 85/100 |
| High 風險問題 | 4 個 | 0 個 |
| 測試覆蓋率 | 80% | 90% |
| 安全分數 | 85/100 | 95/100 |

---

### 🔄 後續行動

1. **立即執行**
   - 建立 issue 追蹤 P0 問題
   - 指派負責人與期限

2. **排入 Sprint**
   - 將 P1 問題排入下一個 sprint
   - 預估工作量與資源

3. **建立 PR**
   - 修復完成後呼叫 `/git-workflow-agent` 建立 PR
   - PR 描述中引用此報告的問題編號

4. **定期審查**
   - 每週執行此 workflow 追蹤進度
   - 每月產出品質趨勢報告

---

## 輸出格式範例

```
🔍 完整代碼審查報告
執行時間: 2025-01-17 10:30:00
審查範圍: 整個 Workspace

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📊 總體品質評分: 78/100

安全性:   ██████████ 85/100 (2 High, 3 Medium)
程式品質: ████████░░ 78/100 (2 High, 4 Medium)
效能:     ███████░░░ 72/100 (1 High, 2 Medium)
測試覆蓋: ████████░░ 80/100 (1 High, 5 模組 < 80%)

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🚨 高優先級問題 (4 個)

P0-1 [安全] API Key 硬編碼
     位置: src/config.py:12
     建議: 移至 .env，revoke 現有 key

P0-2 [品質] 無錯誤處理
     位置: src/db.py:45
     建議: 新增 try-except 與重試機制

...

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🎯 建議修復順序

階段 1 (緊急): P0-1, P0-2
階段 2 (本週): P1-3, P1-4
階段 3 (下週): 重構 + 優化

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

## 互動原則

- **依序執行**所有 agents，等待每個完成後再執行下一個
- **整合結果**時，將相同問題合併（例如同一個函式被多個 agents 標記）
- **優先級計算**考慮影響範圍、嚴重程度、修復難度
- **提供可執行的後續步驟**，不只列出問題
- **產出可追蹤的指標**，方便持續改善

請產出完整的綜合報告，包含所有章節與具體數字。
